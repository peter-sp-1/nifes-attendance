<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fellowship Attendance</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-6">ðŸ“– Fellowship Attendance</h1>

    <!-- Navigation -->
    <div class="flex justify-center gap-4 mb-6">
      <button onclick="showSection('members')" class="tab-btn">ðŸ‘¥ Members</button>
      <button onclick="showSection('attendance')" class="tab-btn">âœ… Mark Attendance</button>
      <button onclick="showSection('report')" class="tab-btn">ðŸ“Š Report</button>
    </div>

    <!-- Sections -->
    <div id="members" class="section">
      <h2 class="text-xl font-semibold mb-4">Members</h2>
      <form id="addMemberForm" class="flex gap-2 mb-4">
        <input type="text" id="name" placeholder="Name" class="input"/>
        <input type="text" id="phone" placeholder="Phone" class="input"/>
        <button class="btn bg-blue-600 hover:bg-blue-700">Add</button>
      </form>
      <ul id="memberList" class="space-y-2"></ul>
    </div>

    <div id="attendance" class="section hidden">
      <h2 class="text-xl font-semibold mb-4">Mark Attendance</h2>
      <button onclick="startSession()" class="btn bg-green-600 hover:bg-green-700 mb-4">Start New Session</button>
      <ul id="attendanceList" class="space-y-2"></ul>
    </div>

    <div id="report" class="section hidden">
      <h2 class="text-xl font-semibold mb-4">Attendance Report</h2>
      <button onclick="loadReport()" class="btn bg-purple-600 hover:bg-purple-700 mb-4">Load Report</button>
      <div id="reportContent"></div>
    </div>
  </div>

  <script>
    const API = "/api";

    // Switch section
    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    // Load members
    async function loadMembers() {
      const res = await fetch(`${API}/members`);
      const members = await res.json();
      const list = document.getElementById("memberList");
      list.innerHTML = members.map(m => `
        <li class="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
          <span>${m.name} (${m.phone})</span>
          <button onclick="removeMember('${m.id}')" class="text-red-600">ðŸ—‘</button>
        </li>
      `).join("");
      // For attendance list
      document.getElementById("attendanceList").innerHTML = members.map(m => `
        <li class="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
          <span>${m.name}</span>
          <button onclick="markAttendance('${m.id}')" class="btn bg-green-500 hover:bg-green-600">Mark Present</button>
        </li>
      `).join("");
    }

    // Add member
    document.getElementById("addMemberForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const phone = document.getElementById("phone").value;
      await fetch(`${API}/members`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, phone })
      });
      e.target.reset();
      loadMembers();
    });

    // Remove member
    async function removeMember(id) {
      await fetch(`${API}/members/${id}`, { method: "DELETE" });
      loadMembers();
    }

    // Start session
    async function startSession() {
      await fetch(`${API}/sessions/start`, { method: "POST" });
      alert("âœ… New session started!");
    }

    // Mark attendance
    async function markAttendance(memberId) {
      const res = await fetch(`${API}/attendance`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ memberId })
      });
      const data = await res.json();
      if (res.ok) {
        alert("Attendance marked!");
      } else {
        alert(data.error);
      }
    }

    // Load report
    async function loadReport() {
      const res = await fetch(`${API}/attendance/report`);
      const content = document.getElementById("reportContent");
      if (!res.ok) {
        content.innerHTML = "<p class='text-red-500'>No active session</p>";
        return;
      }
      const data = await res.json();
      content.innerHTML = `
        <h3 class="font-semibold mb-2">Session: ${new Date(data.session.date).toLocaleString()}</h3>
        <table class="w-full border border-gray-300">
          <thead class="bg-gray-100">
            <tr><th class="border p-2">Name</th><th class="border p-2">Phone</th><th class="border p-2">Status</th></tr>
          </thead>
          <tbody>
            ${data.report.map(r => `
              <tr>
                <td class="border p-2">${r.name}</td>
                <td class="border p-2">${r.phone}</td>
                <td class="border p-2 ${r.attended ? "text-green-600 font-bold" : "text-red-600"}">
                  ${r.attended ? "âœ” Present" : "âœ˜ Absent"}
                </td>
              </tr>`).join("")}
          </tbody>
        </table>
      `;
    }

    // Styling helpers
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.className += " px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300";
    });
    document.querySelectorAll(".btn").forEach(btn => {
      btn.className += " text-white px-3 py-1 rounded-lg";
    });
    document.querySelectorAll(".input").forEach(inp => {
      inp.className += " border p-2 rounded-lg flex-1";
    });

    loadMembers();
  </script>
</body>
</html>
