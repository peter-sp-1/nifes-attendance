<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fellowship Attendance</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-5xl bg-white rounded-2xl shadow-lg p-8">
    <h1 class="text-3xl font-bold text-center mb-8 text-blue-700">📖 Fellowship Attendance</h1>

    <!-- Navigation -->
    <div class="flex justify-center gap-4 mb-8">
      <button onclick="showSection('members')" class="tab-btn">👥 Members</button>
      <button onclick="showSection('sessions')" class="tab-btn">📅 Sessions</button>
      <button onclick="showSection('attendance')" class="tab-btn">✅ Attendance</button>
      <button onclick="showSection('report')" class="tab-btn">📊 Report</button>
    </div>

    <!-- Sections -->
    <!-- Members -->
    <div id="members" class="section">
      <h2 class="text-2xl font-semibold mb-4">👥 Members</h2>
      <form id="addMemberForm" class="flex gap-2 mb-6">
        <input type="text" id="name" placeholder="Full Name" class="input"/>
        <input type="text" id="phone" placeholder="Phone Number" class="input"/>
        <button class="btn bg-blue-600 hover:bg-blue-700">➕ Add</button>
      </form>
      <ul id="memberList" class="space-y-2"></ul>
    </div>

    <!-- Create Session -->
    <div id="sessions" class="section hidden">
      <h2 class="text-2xl font-semibold mb-4">📅 Create New Session</h2>
      <div class="flex items-center gap-4 mb-6">
        <input id="sessionName" type="text" placeholder="e.g. Sunday Service"
          class="p-3 border rounded-lg flex-grow"/>
        <button onclick="createSession()" class="btn bg-blue-600 hover:bg-blue-700">✨ Create & Generate QR</button>
      </div>
      <div id="qrDisplay" class="hidden text-center">
        <p class="mb-4 font-medium text-gray-700">Scan this QR to mark attendance:</p>
        <img id="qrCodeImg" class="mx-auto w-56 h-56 border rounded-xl shadow-lg p-2" />
      </div>
    </div>

    <!-- Attendance -->
    <div id="attendance" class="section hidden">
      <h2 class="text-2xl font-semibold mb-4">✅ Mark Attendance</h2>
      <ul id="attendanceList" class="space-y-2"></ul>
    </div>

    <!-- Report -->
    <div id="report" class="section hidden">
      <h2 class="text-2xl font-semibold mb-4">📊 Attendance Report</h2>
      <button onclick="loadReport()" class="btn bg-purple-600 hover:bg-purple-700 mb-4">📥 Load Report</button>
      <div id="reportContent"></div>
    </div>
  </div>

  <script>
    // ✅ Change this to your deployed backend
    const API = "https://nifes-attendance.onrender.com/api";

    // Switch section
    function showSection(id) {
      document.querySelectorAll(".section").forEach(s => s.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    // Load members
    async function loadMembers() {
      const res = await fetch(`${API}/members`);
      const members = await res.json();
      const list = document.getElementById("memberList");
      list.innerHTML = members.map(m => `
        <li class="flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm">
          <span>${m.name} (${m.phone})</span>
          <button onclick="removeMember('${m.id}')" class="text-red-600 hover:text-red-800">🗑 Remove</button>
        </li>
      `).join("");

      document.getElementById("attendanceList").innerHTML = members.map(m => `
        <li class="flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm">
          <span>${m.name}</span>
          <button onclick="markAttendance('${m.id}')" class="btn bg-green-500 hover:bg-green-600">✔ Present</button>
        </li>
      `).join("");
    }

    // Add member
    document.getElementById("addMemberForm").addEventListener("submit", async e => {
      e.preventDefault();
      const name = document.getElementById("name").value;
      const phone = document.getElementById("phone").value;
      await fetch(`${API}/members`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, phone })
      });
      e.target.reset();
      loadMembers();
    });

    // Remove member
    async function removeMember(id) {
      await fetch(`${API}/members/${id}`, { method: "DELETE" });
      loadMembers();
    }

    // Create session + show QR
    async function createSession() {
      const name = document.getElementById("sessionName").value;
      if (!name) return alert("⚠ Please enter a session name");

      const res = await fetch(`${API}/sessions`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name }),
      });

      const data = await res.json();

      if (data.qr) {
        document.getElementById("qrDisplay").classList.remove("hidden");
        document.getElementById("qrCodeImg").src = data.qr;
      } else {
        alert("❌ Failed to create session");
      }
    }

    // Mark attendance
    async function markAttendance(memberId) {
      const res = await fetch(`${API}/attendance`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ memberId })
      });
      const data = await res.json();
      if (res.ok) {
        alert("✅ Attendance marked!");
      } else {
        alert(data.error || "❌ Failed to mark attendance");
      }
    }

    // Load report
    async function loadReport() {
      const res = await fetch(`${API}/attendance/report`);
      const content = document.getElementById("reportContent");
      if (!res.ok) {
        content.innerHTML = "<p class='text-red-500'>⚠ No active session found</p>";
        return;
      }
      const data = await res.json();
      content.innerHTML = `
        <h3 class="font-semibold mb-4 text-gray-700">📅 Session: ${new Date(data.session.date).toLocaleString()}</h3>
        <table class="w-full border border-gray-300 text-sm">
          <thead class="bg-gray-200">
            <tr><th class="border p-2">Name</th><th class="border p-2">Phone</th><th class="border p-2">Status</th></tr>
          </thead>
          <tbody>
            ${data.report.map(r => `
              <tr>
                <td class="border p-2">${r.name}</td>
                <td class="border p-2">${r.phone}</td>
                <td class="border p-2 ${r.attended ? "text-green-600 font-bold" : "text-red-600"}">
                  ${r.attended ? "✔ Present" : "✘ Absent"}
                </td>
              </tr>`).join("")}
          </tbody>
        </table>
      `;
    }

    // Styling helpers
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.className += " px-5 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition";
    });
    document.querySelectorAll(".btn").forEach(btn => {
      btn.className += " text-white px-4 py-2 rounded-lg shadow transition";
    });
    document.querySelectorAll(".input").forEach(inp => {
      inp.className += " border p-3 rounded-lg flex-1 shadow-sm";
    });

    loadMembers();
  </script>
</body>
</html>
